import{d as N,c as v,a as y,u as O,h as T,w as q,b as e,o as h,t as f,f as A,D as j,m as X,z as I,y as V,e as S,F as L,r as z,g as n,n as x,A as B}from"./app-C4RxZQeq.js";import{_ as F}from"./InputError.vue_vue_type_script_setup_true_lang-DclnpkCj.js";import{_ as W}from"./LoadingButton.vue_vue_type_script_setup_true_lang-BZdzqf8S.js";import{_ as Y,u as J}from"./AppLayout.vue_vue_type_script_setup_true_lang-BkC7_KcU.js";import"./index-2UITHzBk.js";import"./Spinner.vue_vue_type_script_setup_true_lang-CzuqRdQf.js";import"./createLucideIcon-CIIjH0AZ.js";import"./index-Cv2cN02m.js";import"./index-CQCdNE30.js";import"./Presence-C6NHUOAT.js";import"./useForwardExpose-CwMYFS2I.js";import"./useForwardPropsEmits-VfW6L23Z.js";import"./VisuallyHidden-BekQp5so.js";import"./x-BuNzBGro.js";import"./index-Dgh_0kKE.js";import"./BottomNav.vue_vue_type_script_setup_true_lang-DN7C7JYV.js";const K={class:"mx-auto w-full max-w-3xl space-y-5 p-4"},G={key:0,class:"rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-700 dark:text-emerald-300"},Q={key:1,class:"space-y-1"},Z={class:"text-xs text-muted-foreground"},ee={class:"h-2 w-full overflow-hidden rounded-full bg-muted"},te={key:2,class:"space-y-1"},oe={class:"text-xs text-muted-foreground"},se={class:"h-2 w-full overflow-hidden rounded-full bg-muted"},ae={class:"text-sm text-muted-foreground"},le={class:"grid gap-2"},re={class:"grid gap-3"},ne=["disabled"],ue={class:"grid grid-cols-2 gap-3 md:grid-cols-4"},de=["src"],ie=["onClick"],Ae=N({__name:"Create",setup(pe){const w=B(),g=n(""),r=n([]),u=n(!1),m=n(!1),d=n(0),i=n({}),P=n(""),p=n(0),R=J(),M=x(()=>r.value.map(a=>({file:a,url:URL.createObjectURL(a)}))),U=x(()=>w.props.auth.user?.photo_limit??12),$=x(()=>w.props.auth.user?.photo_count??0),k=x(()=>w.props.auth.user?.photo_slots_remaining??0),b=x(()=>k.value<=0),D=a=>{if(b.value)return;const o=a.target,s=Array.from(o.files??[]),l=Math.min(k.value,4),t=[...r.value,...s].slice(0,l);r.value=t},E=a=>{r.value=r.value.filter((o,s)=>s!==a)},H=async()=>{if(i.value={},g.value.trim()===""&&r.value.length===0){i.value.body="Add a caption or at least one photo.";return}if(b.value){i.value.photos="You have reached the maximum of 12 photos. Delete one to add another.";return}u.value=!0,m.value=!0,d.value=0,p.value=0;const a=new FormData;a.append("body",g.value),r.value.forEach(s=>{a.append("photos[]",s)});const o=()=>new Promise((s,l)=>{const t=new XMLHttpRequest;t.open("POST","/posts"),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("X-CSRF-TOKEN",document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??""),t.upload.onprogress=c=>{c.lengthComputable&&(d.value=Math.round(c.loaded/c.total*100))},t.onload=()=>{try{const c=JSON.parse(t.responseText);s({status:t.status,payload:c})}catch{l(new Error("Invalid upload response"))}},t.onerror=()=>{l(new Error("Upload failed"))},t.send(a)});try{const s=await o();m.value=!1,d.value=100;const l=s.payload;if(s.status<200||s.status>=300){i.value=Object.fromEntries(Object.entries(l.errors??{}).map(([C,_])=>[C,_[0]??"Invalid value."])),u.value=!1,m.value=!1;return}const t=l.data?.post_id;if(t===void 0){u.value=!1;return}P.value=l.message??"Photo uploaded successfully. Your post will be visible in a minute or two.",R.start(),p.value=10;const c=window.setInterval(async()=>{const _=await(await fetch(`/posts/${t}/status`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}})).json();R.setPercent(_.data?.progress??0),p.value=_.data?.progress??0,_.data?.published&&(window.clearInterval(c),R.finish(),g.value="",r.value=[],u.value=!1,m.value=!1,d.value=0,p.value=0)},2e3)}catch{i.value.body="Failed to publish post.",u.value=!1,m.value=!1,d.value=0,p.value=0}};return(a,o)=>(h(),v(L,null,[y(O(T),{title:"Add Photo"}),y(Y,null,{default:q(()=>[e("div",K,[o[4]||(o[4]=e("h1",{class:"text-2xl font-semibold"},"Add Photo",-1)),P.value!==""?(h(),v("p",G,f(P.value),1)):A("",!0),m.value?(h(),v("div",Q,[e("p",Z," Uploading photos... "+f(d.value)+"% ",1),e("div",ee,[e("div",{class:"h-full bg-primary transition-all duration-150",style:j({width:`${d.value}%`})},null,4)])])):u.value?(h(),v("div",te,[e("p",oe," Processing photos... "+f(p.value)+"% ",1),e("div",se,[e("div",{class:"h-full bg-primary transition-all duration-200",style:j({width:`${p.value}%`})},null,4)])])):A("",!0),e("p",ae," Photos used: "+f($.value)+" / "+f(U.value)+". Remaining: "+f(k.value)+". ",1),e("div",le,[o[1]||(o[1]=e("label",{for:"post-body",class:"text-sm font-medium"},"Caption",-1)),X(e("textarea",{id:"post-body","onUpdate:modelValue":o[0]||(o[0]=s=>g.value=s),rows:"5",class:"rounded-md border border-input bg-background px-3 py-2 text-sm",placeholder:"Write something about this photo (optional)..."},null,512),[[I,g.value]]),y(F,{message:i.value.body},null,8,["message"])]),e("div",re,[e("label",{class:V(["flex min-h-28 cursor-pointer items-center justify-center rounded-lg border border-dashed border-border text-sm text-muted-foreground",{"pointer-events-none opacity-60":b.value}])},[o[2]||(o[2]=S(" Click to upload photos (max 4) ",-1)),e("input",{type:"file",class:"hidden",accept:".jpg,.jpeg,.png,.webp,.gif,.avif",multiple:"",disabled:b.value,onChange:D},null,40,ne)],2),y(F,{message:i.value.photos},null,8,["message"]),e("div",ue,[(h(!0),v(L,null,z(M.value,(s,l)=>(h(),v("div",{key:l,class:"relative overflow-hidden border border-border"},[e("img",{src:s.url,alt:"Selected photo",class:"aspect-square w-full object-cover"},null,8,de),e("button",{type:"button",class:"absolute top-1 right-1 rounded-full bg-background/90 px-2 py-1 text-xs","aria-label":"Remove photo",onClick:t=>E(l)}," Ã— ",8,ie)]))),128))])]),y(W,{loading:u.value,"loading-text":"Adding...",disabled:b.value,onClick:H},{default:q(()=>[...o[3]||(o[3]=[S(" Add Photo ",-1)])]),_:1},8,["loading","disabled"])])]),_:1})],64))}});export{Ae as default};
