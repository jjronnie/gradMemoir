import{d as N,c as v,a as _,u as O,h as T,w as q,b as e,o as h,t as f,f as j,D as A,m as X,A as I,s as V,e as S,F as L,r as B,g as n,x,E as W}from"./app-BXlxvPJ4.js";import{_ as E}from"./InputError.vue_vue_type_script_setup_true_lang-DDcA0SiJ.js";import{_ as z}from"./LoadingButton.vue_vue_type_script_setup_true_lang-HJHBRm1v.js";import{_ as Y,u as J}from"./AppLayout.vue_vue_type_script_setup_true_lang-DG7I23hc.js";import"./FlashMessages.vue_vue_type_script_setup_true_lang-HONSxRlG.js";import"./Spinner.vue_vue_type_script_setup_true_lang-DuwWGKtl.js";import"./createLucideIcon-BhpRTv15.js";import"./index-C78dSs6T.js";import"./index-BB3w2Cxu.js";import"./RovingFocusGroup-DWhwfIpB.js";import"./useForwardExpose-COt-7_XK.js";import"./UserMenuContent.vue_vue_type_script_setup_true_lang-D9b9PEsY.js";import"./useForwardPropsEmits-CYY9JK-I.js";import"./index-ueziRkVZ.js";import"./VisuallyHidden-C9aoMcVK.js";const K={class:"mx-auto w-full max-w-3xl space-y-5 p-4"},G={key:0,class:"rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-700 dark:text-emerald-300"},Q={key:1,class:"space-y-1"},Z={class:"text-xs text-muted-foreground"},ee={class:"h-2 w-full overflow-hidden rounded-full bg-muted"},te={key:2,class:"space-y-1"},se={class:"text-xs text-muted-foreground"},oe={class:"h-2 w-full overflow-hidden rounded-full bg-muted"},ae={class:"text-sm text-muted-foreground"},le={class:"grid gap-2"},re={class:"grid gap-3"},ne=["disabled"],ue={class:"grid grid-cols-2 gap-3 md:grid-cols-4"},de=["src"],ie=["onClick"],qe=N({__name:"Create",setup(pe){const w=W(),y=n(""),r=n([]),u=n(!1),m=n(!1),d=n(0),i=n({}),P=n(""),p=n(0),R=J(),F=x(()=>r.value.map(a=>({file:a,url:URL.createObjectURL(a)}))),M=x(()=>w.props.auth.user?.photo_limit??8),U=x(()=>w.props.auth.user?.photo_count??0),k=x(()=>w.props.auth.user?.photo_slots_remaining??0),g=x(()=>k.value<=0),$=a=>{if(g.value)return;const s=a.target,o=Array.from(s.files??[]),l=Math.min(k.value,4),t=[...r.value,...o].slice(0,l);r.value=t},D=a=>{r.value=r.value.filter((s,o)=>o!==a)},H=async()=>{if(i.value={},r.value.length===0){i.value.photos="Please attach at least one photo.";return}if(g.value){i.value.photos="You have reached the maximum of 8 photos. Delete one to add another.";return}u.value=!0,m.value=!0,d.value=0,p.value=0;const a=new FormData;a.append("body",y.value),r.value.forEach(o=>{a.append("photos[]",o)});const s=()=>new Promise((o,l)=>{const t=new XMLHttpRequest;t.open("POST","/posts"),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("X-CSRF-TOKEN",document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??""),t.upload.onprogress=c=>{c.lengthComputable&&(d.value=Math.round(c.loaded/c.total*100))},t.onload=()=>{try{const c=JSON.parse(t.responseText);o({status:t.status,payload:c})}catch{l(new Error("Invalid upload response"))}},t.onerror=()=>{l(new Error("Upload failed"))},t.send(a)});try{const o=await s();m.value=!1,d.value=100;const l=o.payload;if(o.status<200||o.status>=300){i.value=Object.fromEntries(Object.entries(l.errors??{}).map(([C,b])=>[C,b[0]??"Invalid value."])),u.value=!1,m.value=!1;return}const t=l.data?.post_id;if(t===void 0){u.value=!1;return}P.value=l.message??"Photo uploaded successfully. Your post will be visible in a minute or two.",R.start(),p.value=10;const c=window.setInterval(async()=>{const b=await(await fetch(`/posts/${t}/status`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}})).json();R.setPercent(b.data?.progress??0),p.value=b.data?.progress??0,b.data?.published&&(window.clearInterval(c),R.finish(),y.value="",r.value=[],u.value=!1,m.value=!1,d.value=0,p.value=0)},2e3)}catch{i.value.body="Failed to publish post.",u.value=!1,m.value=!1,d.value=0,p.value=0}};return(a,s)=>(h(),v(L,null,[_(O(T),{title:"Add Photo"}),_(Y,null,{default:q(()=>[e("div",K,[s[4]||(s[4]=e("h1",{class:"text-2xl font-semibold"},"Add Photo",-1)),P.value!==""?(h(),v("p",G,f(P.value),1)):j("",!0),m.value?(h(),v("div",Q,[e("p",Z," Uploading photos... "+f(d.value)+"% ",1),e("div",ee,[e("div",{class:"h-full bg-primary transition-all duration-150",style:A({width:`${d.value}%`})},null,4)])])):u.value?(h(),v("div",te,[e("p",se," Processing photos... "+f(p.value)+"% ",1),e("div",oe,[e("div",{class:"h-full bg-primary transition-all duration-200",style:A({width:`${p.value}%`})},null,4)])])):j("",!0),e("p",ae," Photos used: "+f(U.value)+" / "+f(M.value)+". Remaining: "+f(k.value)+". ",1),e("div",le,[s[1]||(s[1]=e("label",{for:"post-body",class:"text-sm font-medium"},"Caption",-1)),X(e("textarea",{id:"post-body","onUpdate:modelValue":s[0]||(s[0]=o=>y.value=o),rows:"5",class:"rounded-md border border-input bg-background px-3 py-2 text-sm",placeholder:"Write something about this photo (optional)..."},null,512),[[I,y.value]]),_(E,{message:i.value.body},null,8,["message"])]),e("div",re,[e("label",{class:V(["flex min-h-28 cursor-pointer items-center justify-center rounded-lg border border-dashed border-border text-sm text-muted-foreground",{"pointer-events-none opacity-60":g.value}])},[s[2]||(s[2]=S(" Click to upload photos (max 4) ",-1)),e("input",{type:"file",class:"hidden",accept:".jpg,.jpeg,.png,.webp,.gif,.avif",multiple:"",disabled:g.value,onChange:$},null,40,ne)],2),_(E,{message:i.value.photos},null,8,["message"]),e("div",ue,[(h(!0),v(L,null,B(F.value,(o,l)=>(h(),v("div",{key:l,class:"relative overflow-hidden border border-border"},[e("img",{src:o.url,alt:"Selected photo",class:"aspect-square w-full object-cover"},null,8,de),e("button",{type:"button",class:"absolute top-1 right-1 rounded-full bg-background/90 px-2 py-1 text-xs","aria-label":"Remove photo",onClick:t=>D(l)}," Ã— ",8,ie)]))),128))])]),_(z,{loading:u.value,"loading-text":"Adding...",disabled:g.value,onClick:H},{default:q(()=>[...s[3]||(s[3]=[S(" Add Photo ",-1)])]),_:1},8,["loading","disabled"])])]),_:1})],64))}});export{qe as default};
